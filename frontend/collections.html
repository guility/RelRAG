<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RelRAG — Коллекции</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/theme.js"></script>
</head>
<body>
  <header>
    <h1>RelRAG</h1>
    <nav class="flex gap-1">
      <a href="index.html">Главная</a>
      <a href="configurations.html">Конфигурации</a>
      <a href="collections.html">Коллекции</a>
      <a href="document.html">Документ</a>
      <button type="button" id="btnTheme" aria-label="Тема"></button>
      <button type="button" id="btnLogout">Выход</button>
    </nav>
  </header>

  <main>
    <h2>Коллекции</h2>
    <div id="hintNoConfig" class="hint" style="display:none">
      <strong>Как создать первую коллекцию</strong>
      <ol>
        <li>Сначала создайте <a href="configurations.html">конфигурацию</a> (модель эмбеддингов, размер чанка).</li>
        <li>Затем выберите её здесь и нажмите «Создать».</li>
        <li>После создания загрузите документы через <a href="document.html">Документ</a>.</li>
      </ol>
    </div>
    <form id="formCreate">
      <label>Название <input type="text" name="name" placeholder="Например: Документация проекта" maxlength="255"></label>
      <label>Конфигурация <select id="configId" name="configuration_id" required></select></label>
      <button type="submit">Создать</button>
    </form>
    <div id="list"></div>
  </main>

  <script src="js/layout.js"></script>
  <script src="vendor/keycloak.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script>
    (function () {
      const api = window.relragApi;
      const auth = window.relragAuth;
      function escapeHtml(s) { return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }

      function loadConfigs() {
        return api.get("/v1/configurations").then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          const sel = document.getElementById("configId");
          const hint = document.getElementById("hintNoConfig");
          sel.innerHTML = "<option value=''>Выберите конфигурацию</option>";
          if (data && data.items && data.items.length > 0) {
            if (hint) hint.style.display = "none";
            data.items.forEach(function (c) {
              var configLabel = (c.name && c.name.trim()) ? c.name : c.id;
              sel.innerHTML += "<option value='" + c.id + "'>" + escapeHtml(configLabel) + " (" + escapeHtml(c.embedding_model) + ")</option>";
            });
          } else {
            if (hint) hint.style.display = "block";
          }
        }).catch(function (err) {
          api.showError(err, "list", "Не удалось загрузить конфигурации:");
        });
      }

      function loadList() {
        return api.get("/v1/collections").then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          const el = document.getElementById("list");
          if (data && data.items && data.items.length > 0) {
            el.innerHTML = "<div class='card'><div class='table-wrap'><table><thead><tr><th>Название</th><th>Конфигурация</th><th>Создана</th><th></th></tr></thead><tbody>" +
              data.items.map(function (c) {
                var name = (c.name && c.name.trim()) ? c.name : c.id;
                return "<tr><td>" + escapeHtml(name) + "</td><td>" + escapeHtml(c.configuration_id) + "</td><td>" + c.created_at + "</td>" +
                  "<td><a href='collection.html?id=" + c.id + "'>Открыть</a></td></tr>";
              }).join("") + "</tbody></table></div></div>";
          } else {
            el.innerHTML = "<p>Нет коллекций</p>";
          }
        }).catch(function (err) {
          api.showError(err, "list", "Не удалось загрузить коллекции:");
        });
      }

      document.getElementById("btnLogout").onclick = function () { auth.logout(); };

      document.getElementById("formCreate").onsubmit = function (e) {
        e.preventDefault();
        const form = e.target;
        const configId = document.getElementById("configId").value;
        const nameVal = (form.name && form.name.value || "").trim();
        if (!configId) return;
        api.post("/v1/collections", { configuration_id: configId, name: nameVal || undefined }).then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          if (data && data.id) {
            loadList();
          }
        }).catch(function (err) {
          api.showError(err, "list", "Не удалось создать коллекцию:");
        });
      };

      function runWhenReady() {
        return Promise.all([loadConfigs(), loadList()]);
      }
      auth.init().then(function (authenticated) {
        if (!authenticated) auth.login();
        else auth.updateToken(30).then(runWhenReady).catch(function () { auth.login(); });
      }).catch(function () { auth.login(); });
    })();
  </script>
</body>
</html>
