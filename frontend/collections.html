<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>RelRAG — Коллекции</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <h1>RelRAG</h1>
    <nav>
      <a href="index.html">Главная</a>
      <a href="configurations.html">Конфигурации</a>
      <a href="collections.html">Коллекции</a>
      <a href="document.html">Документ</a>
      <button type="button" id="btnLogout">Выход</button>
    </nav>
  </header>

  <main>
    <h2>Коллекции</h2>
    <form id="formCreate">
      <label>Конфигурация <select id="configId" name="configuration_id" required></select></label>
      <button type="submit">Создать</button>
    </form>
    <div id="list"></div>
  </main>

  <script src="vendor/keycloak.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script>
    (function () {
      const api = window.relragApi;
      const auth = window.relragAuth;

      function loadConfigs() {
        api.get("/v1/configurations").then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          const sel = document.getElementById("configId");
          sel.innerHTML = "<option value=''>Выберите конфигурацию</option>";
          if (data && data.items) {
            data.items.forEach(function (c) {
              sel.innerHTML += "<option value='" + c.id + "'>" + c.id + " (" + c.embedding_model + ")</option>";
            });
          }
        }).catch(function () {});
      }

      function loadList() {
        api.get("/v1/collections").then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          const el = document.getElementById("list");
          if (data && data.items && data.items.length > 0) {
            el.innerHTML = "<table><thead><tr><th>ID</th><th>Конфигурация</th><th>Создана</th><th></th></tr></thead><tbody>" +
              data.items.map(function (c) {
                return "<tr><td>" + c.id + "</td><td>" + c.configuration_id + "</td><td>" + c.created_at + "</td>" +
                  "<td><a href='collection.html?id=" + c.id + "'>Открыть</a></td></tr>";
              }).join("") + "</tbody></table>";
          } else {
            el.innerHTML = "<p>Нет коллекций</p>";
          }
        }).catch(function () {});
      }

      document.getElementById("btnLogout").onclick = function () { auth.logout(); };

      document.getElementById("formCreate").onsubmit = function (e) {
        e.preventDefault();
        const configId = document.getElementById("configId").value;
        if (!configId) return;
        api.post("/v1/collections", { configuration_id: configId }).then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          if (data && data.id) {
            loadList();
          }
        }).catch(function () {});
      };

      auth.init().then(function (authenticated) {
        if (!authenticated) auth.login();
        else {
          loadConfigs();
          loadList();
        }
      }).catch(function () { auth.login(); });
    })();
  </script>
</body>
</html>
