<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RelRAG — Коллекция</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/theme.js"></script>
</head>
<body>
  <header>
    <h1>RelRAG</h1>
    <nav class="flex gap-1">
      <a href="index.html">Главная</a>
      <a href="configurations.html">Конфигурации</a>
      <a href="collections.html">Коллекции</a>
      <a href="document.html">Документ</a>
      <button type="button" id="btnTheme" aria-label="Тема"></button>
      <button type="button" id="btnLogout">Выход</button>
    </nav>
  </header>

  <main>
    <h2><span id="collTitle">Коллекция</span></h2>
    <div id="info"></div>
    <h3>Поиск</h3>
    <div class="hint">
      <strong>Семантический поиск</strong>
      <p>Введите запрос — система найдёт наиболее релевантные фрагменты из загруженных документов по смыслу.</p>
    </div>
    <form id="formSearch">
      <label>Запрос <input type="text" id="searchQuery" placeholder="текст для поиска" required></label>
      <div class="search-options">
        <label>Доля семантического (0–1) <input type="number" id="searchVectorWeight" min="0" max="1" step="0.1" value="0.7"></label>
        <label>Доля полнотекстового (0–1) <input type="number" id="searchFtsWeight" min="0" max="1" step="0.1" value="0.3"></label>
        <label>Макс. результатов <input type="number" id="searchLimit" min="1" max="100" value="10"></label>
      </div>
      <div id="searchFilters" class="card search-filters-wrap" style="display:none"></div>
      <button type="submit">Искать</button>
    </form>
    <div id="searchResults"></div>
    <h3>Загрузить документ</h3>
    <form id="formDoc">
      <label>Текст <textarea id="docContent" rows="5" required></textarea></label>
      <button type="submit" id="btnDocSubmit">Загрузить</button>
    </form>
    <div id="uploadProgress" class="upload-progress upload-progress-indeterminate" style="display:none" aria-live="polite">
      <div class="upload-progress-bar-wrap">
        <div class="upload-progress-bar" role="progressbar" aria-valuetext="Обработка"></div>
      </div>
      <div class="upload-progress-label">Обработка документа…</div>
    </div>
    <p><a href="admin.html" id="adminLink">Админ-панель</a></p>
  </main>

  <script src="js/layout.js"></script>
  <script src="vendor/keycloak.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script>
    (function () {
      const api = window.relragApi;
      const auth = window.relragAuth;
      function escapeHtml(s) { return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }
      const params = new URLSearchParams(window.location.search);
      const collId = params.get("id");

      if (!collId) {
        document.body.innerHTML = "<main><p>Не указан ID коллекции. <a href='collections.html'>К коллекциям</a></p></main>";
        throw new Error("No collection id");
      }

      document.getElementById("collTitle").textContent = "Коллекция " + collId;
      document.getElementById("adminLink").href = "admin.html?collection=" + collId;

      function loadInfo() {
        return api.get("/v1/collections/" + collId).then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          const el = document.getElementById("info");
          if (data && data.id) {
            var collName = (data.name && data.name.trim()) ? data.name : data.id;
            document.getElementById("collTitle").textContent = collName;
            el.innerHTML = "<div class='card'><p>Конфигурация: " + escapeHtml(data.configuration_id) + "</p></div>";
          } else {
            el.innerHTML = "<p class='error'>Не удалось загрузить</p>";
          }
        }).catch(function (err) {
          api.showError(err, "info", "Не удалось загрузить коллекцию:");
        });
      }

      document.getElementById("btnLogout").onclick = function () { auth.logout(); };

      var propertySchema = [];
      var activeFilterKeys = [];
      function getPropLabel(prop) { return (prop.label && prop.label.trim()) ? prop.label : prop.key; }
      function renderFilterBlocks() {
        var wrap = document.getElementById("searchFilterBlocks");
        if (!wrap) return;
        wrap.innerHTML = "";
        activeFilterKeys.forEach(function (key) {
          var prop = propertySchema.find(function (p) { return p.key === key; });
          if (!prop) return;
          var block = document.createElement("div");
          block.className = "filter-block";
          block.setAttribute("data-key", prop.key);
          block.setAttribute("data-type", prop.type);
          var label = getPropLabel(prop);
          if (prop.type === "string" && prop.values && prop.values.length > 0) {
            block.innerHTML = "<span class='filter-block-label'>" + escapeHtml(label) + " (мультивыбор)</span> " +
              "<button type='button' class='filter-remove-btn' data-key='" + escapeHtml(prop.key) + "' aria-label='Удалить'>×</button>" +
              "<input type='text' class='filter-search' placeholder='Поиск...'>" +
              "<div class='filter-values'>" +
              (prop.values.map(function (v) {
                return "<label class='filter-value-label'><input type='checkbox' class='filter-one-of' value=\"" + String(v).replace(/"/g, "&quot;") + "\"> " + escapeHtml(String(v)) + "</label>";
              }).join("")) + "</div>";
          } else if (prop.type === "bool") {
            block.innerHTML = "<label class='filter-bool-label'><input type='checkbox' class='filter-bool'> " + escapeHtml(label) + " (да)</label> " +
              "<button type='button' class='filter-remove-btn' data-key='" + escapeHtml(prop.key) + "' aria-label='Удалить'>×</button>";
          } else if (prop.type === "int" || prop.type === "float" || prop.type === "date") {
            var inputType = prop.type === "date" ? "date" : "number";
            block.innerHTML = "<span class='filter-block-label'>" + escapeHtml(label) + "</span> " +
              "<button type='button' class='filter-remove-btn' data-key='" + escapeHtml(prop.key) + "' aria-label='Удалить'>×</button>" +
              "<span>От <input type='" + inputType + "' class='filter-gte'></span> " +
              "<span>До <input type='" + inputType + "' class='filter-lte'></span>";
          } else {
            block.innerHTML = "<span class='filter-block-label'>" + escapeHtml(label) + " (тип: " + prop.type + ")</span> " +
              "<button type='button' class='filter-remove-btn' data-key='" + escapeHtml(prop.key) + "' aria-label='Удалить'>×</button>";
          }
          wrap.appendChild(block);
        });
        wrap.querySelectorAll(".filter-remove-btn").forEach(function (btn) {
          btn.onclick = function () {
            var k = btn.getAttribute("data-key");
            activeFilterKeys = activeFilterKeys.filter(function (x) { return x !== k; });
            renderFilterBlocks();
          };
        });
        wrap.querySelectorAll(".filter-search").forEach(function (searchInput) {
          searchInput.oninput = function () {
            var q = (searchInput.value || "").toLowerCase();
            var div = searchInput.nextElementSibling;
            if (!div) return;
            div.querySelectorAll("label").forEach(function (l) {
              var text = (l.textContent || "").toLowerCase();
              l.style.display = text.indexOf(q) >= 0 ? "block" : "none";
            });
          };
        });
      }
      function buildFilterDropdown() {
        var container = document.getElementById("searchFilters");
        var wrap = document.createElement("div");
        wrap.className = "search-filters-card card";
        wrap.innerHTML = "<strong>Фильтры по свойствам</strong>" +
          "<button type='button' class='btn outlined' id='btnAddFilter'>Добавить фильтр</button>" +
          "<div class='filter-add-modal-overlay' id='filterAddModalOverlay' aria-hidden='true'>" +
          "<div class='filter-add-modal' role='dialog' aria-labelledby='filterAddModalTitle' aria-modal='true'>" +
          "<div class='filter-add-modal-header'>" +
          "<h4 id='filterAddModalTitle'>Добавить фильтр</h4>" +
          "<button type='button' class='filter-add-modal-close' id='btnFilterAddClose' aria-label='Закрыть'>×</button>" +
          "</div>" +
          "<input type='text' class='filter-add-input' id='filterAddSearch' placeholder='Поиск свойств...' autocomplete='off'>" +
          "<div id='filterAddList' class='filter-add-modal-list'></div>" +
          "</div>" +
          "</div>" +
          "<div id='searchFilterBlocks'></div>";
        container.innerHTML = "";
        container.appendChild(wrap);
        container.style.display = "block";
        var overlay = document.getElementById("filterAddModalOverlay");
        var listEl = document.getElementById("filterAddList");
        var searchInput = document.getElementById("filterAddSearch");
        function openFilterModal() {
          overlay.classList.add("is-open");
          overlay.setAttribute("aria-hidden", "false");
          searchInput.value = "";
          filterAddListFilter("");
          searchInput.focus();
        }
        function closeFilterModal() {
          overlay.classList.remove("is-open");
          overlay.setAttribute("aria-hidden", "true");
        }
        document.getElementById("btnAddFilter").onclick = function (e) {
          e.preventDefault();
          openFilterModal();
        };
        document.getElementById("btnFilterAddClose").onclick = function (e) {
          e.preventDefault();
          closeFilterModal();
        };
        overlay.onclick = function (e) {
          if (e.target === overlay) closeFilterModal();
        };
        document.getElementById("filterAddModalOverlay").querySelector(".filter-add-modal").onclick = function (e) {
          e.stopPropagation();
        };
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && overlay.classList.contains("is-open")) closeFilterModal();
        });
        function filterAddListFilter(q) {
          q = (q || "").toLowerCase();
          listEl.innerHTML = propertySchema.filter(function (p) {
            return activeFilterKeys.indexOf(p.key) === -1 && (q === "" || getPropLabel(p).toLowerCase().indexOf(q) >= 0 || p.key.toLowerCase().indexOf(q) >= 0);
          }).map(function (p) {
            return "<label><input type='checkbox' class='filter-add-one' value='" + escapeHtml(p.key) + "'> " + escapeHtml(getPropLabel(p)) + "</label>";
          }).join("");
          listEl.querySelectorAll(".filter-add-one").forEach(function (cb) {
            cb.onchange = function () {
              if (cb.checked) {
                activeFilterKeys.push(cb.value);
                renderFilterBlocks();
                cb.checked = false;
                closeFilterModal();
              }
            };
          });
        }
        searchInput.oninput = function () { filterAddListFilter(searchInput.value); };
        filterAddListFilter("");
      }
      function loadPropertySchema() {
        return api.get("/v1/collections/" + collId + "/property-schema").then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          propertySchema = (data && data.properties) ? data.properties : [];
          var container = document.getElementById("searchFilters");
          if (propertySchema.length === 0) {
            container.style.display = "none";
            container.innerHTML = "";
            activeFilterKeys = [];
            return;
          }
          activeFilterKeys = [];
          buildFilterDropdown();
          renderFilterBlocks();
        }).catch(function (err) {
          var c = document.getElementById("searchFilters");
          if (c) c.style.display = "block";
          api.showError(err, "searchFilters", "Не удалось загрузить фильтры:");
        });
      }

      function gatherFilters() {
        var filters = {};
        var container = document.getElementById("searchFilterBlocks");
        if (!container) return undefined;
        container.querySelectorAll("[data-key]").forEach(function (block) {
          var key = block.getAttribute("data-key");
          var type = block.getAttribute("data-type");
          if (type === "string") {
            var checked = [];
            block.querySelectorAll(".filter-one-of:checked").forEach(function (cb) { checked.push(cb.value); });
            if (checked.length) filters[key] = { one_of: checked };
          } else if (type === "bool") {
            var cb = block.querySelector(".filter-bool");
            if (cb && cb.checked) filters[key] = true;
          } else if (type === "int" || type === "float" || type === "date") {
            var gte = block.querySelector(".filter-gte");
            var lte = block.querySelector(".filter-lte");
            var v1 = gte && gte.value ? (type === "int" || type === "float" ? parseFloat(gte.value) : gte.value) : null;
            var v2 = lte && lte.value ? (type === "int" || type === "float" ? parseFloat(lte.value) : lte.value) : null;
            if (v1 != null || v2 != null) {
              filters[key] = {};
              if (v1 != null) filters[key].gte = v1;
              if (v2 != null) filters[key].lte = v2;
            }
          }
        });
        return Object.keys(filters).length ? filters : undefined;
      }

      document.getElementById("formSearch").onsubmit = function (e) {
        e.preventDefault();
        const query = document.getElementById("searchQuery").value;
        var body = {
          query: query,
          vector_weight: parseFloat(document.getElementById("searchVectorWeight").value) || 0.7,
          fts_weight: parseFloat(document.getElementById("searchFtsWeight").value) || 0.3,
          limit: parseInt(document.getElementById("searchLimit").value, 10) || 10
        };
        var filters = gatherFilters();
        if (filters) body.filters = filters;
        api.post("/v1/collections/" + collId + "/search", body)
          .then(function (res) { return api.handleResponse(res); })
          .then(function (data) {
            const el = document.getElementById("searchResults");
            if (data && data.results && data.results.length > 0) {
              el.innerHTML = "<ul class='search-results'>" + data.results.map(function (r) {
                var title = (r.document_title && r.document_title.trim()) ? r.document_title : "Без названия";
                var meta = r.metadata || {};
                var metaParts = [];
                if (meta.author) metaParts.push("Автор: " + escapeHtml(String(meta.author)));
                if (meta.created_date) metaParts.push("Создан: " + escapeHtml(String(meta.created_date)));
                if (meta.modified_date) metaParts.push("Изменён: " + escapeHtml(String(meta.modified_date)));
                if (meta.page_count != null && meta.page_count !== "") metaParts.push("Страниц: " + escapeHtml(String(meta.page_count)));
                if (meta.file_size_mb != null && meta.file_size_mb !== "") metaParts.push("Размер: " + escapeHtml(String(meta.file_size_mb)) + " МБ");
                var metaHtml = metaParts.length ? "<div class='result-meta'>" + metaParts.join("; ") + "</div>" : "";
                return "<li class='search-result-item'>" +
                  "<div class='result-doc'>" + escapeHtml(title) + "</div>" +
                  metaHtml +
                  "<div class='result-scores'>Семант.: " + (r.vector_score != null ? r.vector_score : "—") + ", FTS: " + (r.fts_score != null ? r.fts_score : "—") + ", итог: " + (r.score != null ? r.score : "—") + "</div>" +
                  "<div class='result-content'>" + escapeHtml((r.content || "").substring(0, 300)) + (r.content && r.content.length > 300 ? "…" : "") + "</div>" +
                  "</li>";
              }).join("") + "</ul>";
            } else {
              el.innerHTML = "<p>Ничего не найдено</p>";
            }
          }).catch(function (err) {
            api.showError(err, "searchResults", "Ошибка поиска:");
          });
      };

      document.getElementById("formDoc").onsubmit = function (e) {
        e.preventDefault();
        const content = document.getElementById("docContent").value;
        const progressEl = document.getElementById("uploadProgress");
        const btnSubmit = document.getElementById("btnDocSubmit");
        progressEl.style.display = "block";
        btnSubmit.disabled = true;
        api.post("/v1/documents", { collection_id: collId, content: content, properties: {} })
          .then(function (res) { return api.handleResponse(res); })
          .then(function (data) {
            progressEl.style.display = "none";
            btnSubmit.disabled = false;
            if (data && data.id) {
              document.getElementById("docContent").value = "";
              document.getElementById("searchResults").innerHTML = "<p class='success'>Документ загружен</p>";
            }
          }).catch(function (err) {
            progressEl.style.display = "none";
            btnSubmit.disabled = false;
            api.showError(err, "searchResults", "Ошибка загрузки документа:");
          });
      };

      auth.init().then(function (authenticated) {
        if (!authenticated) auth.login();
        else auth.updateToken(30).then(loadInfo).then(loadPropertySchema).catch(function () { auth.login(); });
      }).catch(function () { auth.login(); });
    })();
  </script>
</body>
</html>
