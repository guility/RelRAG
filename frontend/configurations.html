<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RelRAG — Конфигурации</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/theme.js"></script>
</head>
<body>
  <header>
    <h1>RelRAG</h1>
    <nav class="flex gap-1">
      <a href="index.html">Главная</a>
      <a href="configurations.html">Конфигурации</a>
      <a href="collections.html">Коллекции</a>
      <a href="document.html">Документ</a>
      <button type="button" id="btnTheme" aria-label="Тема"></button>
      <button type="button" id="btnLogout">Выход</button>
    </nav>
  </header>

  <main>
    <h2>Конфигурации</h2>
    <div class="hint">
      <strong>Создание конфигурации</strong>
      <p>Конфигурация задаёт модель эмбеддингов и параметры чанкинга. Размерность векторов определяется выбранной моделью автоматически.</p>
    </div>
    <form id="formCreate">
      <label>Название <input type="text" name="name" placeholder="Например: Основная конфигурация" maxlength="255"></label>
      <label>Стратегия чанкинга <select id="chunking" name="chunking_strategy">
        <option value="recursive">recursive</option>
      </select></label>
      <label>Модель эмбеддингов <select id="embeddingModel" name="embedding_model" required></select></label>
      <label>Размер чанка <input type="number" name="chunk_size" value="512" min="64" max="8192"></label>
      <label>Перекрытие <input type="number" name="chunk_overlap" value="50" min="0" max="512"></label>
      <button type="submit">Создать</button>
    </form>
    <div id="list"></div>
  </main>

  <script src="js/layout.js"></script>
  <script src="vendor/keycloak.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script>
    (function () {
      const api = window.relragApi;
      const auth = window.relragAuth;

      function loadModels() {
        return api.get("/v1/models").then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          const sel = document.getElementById("embeddingModel");
          sel.innerHTML = "<option value=''>Выберите модель</option>";
          if (data && data.items && data.items.length > 0) {
            data.items.forEach(function (m) {
              sel.innerHTML += "<option value='" + m.id + "'>" + m.id + " (" + m.dimensions + "d)</option>";
            });
          }
        }).catch(function (err) {
          api.showError(err, "list", "Не удалось загрузить модели эмбеддингов:");
          var sel = document.getElementById("embeddingModel");
          if (sel) sel.innerHTML = "<option value=''>Выберите модель</option>";
        });
      }

      function loadList() {
        return api.get("/v1/configurations").then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          const el = document.getElementById("list");
          if (data && data.items && data.items.length > 0) {
            el.innerHTML = "<div class='card'><div class='table-wrap'><table><thead><tr><th>Название</th><th>Модель</th><th>Чанк</th><th>Перекрытие</th></tr></thead><tbody>" +
              data.items.map(function (c) {
                var name = (c.name && c.name.trim()) ? c.name : c.id;
                return "<tr><td>" + escapeHtml(name) + "</td><td>" + escapeHtml(c.embedding_model) + "</td><td>" + c.chunk_size + "</td><td>" + c.chunk_overlap + "</td></tr>";
              }).join("") + "</tbody></table></div></div>";
          } else {
            el.innerHTML = "<p>Нет конфигураций</p>";
          }
        }).catch(function (err) {
          api.showError(err, "list", "Не удалось загрузить конфигурации:");
        });
      }

      document.getElementById("btnLogout").onclick = function () { auth.logout(); };

      function escapeHtml(s) { return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }
      document.getElementById("formCreate").onsubmit = function (e) {
        e.preventDefault();
        const form = e.target;
        const nameVal = (form.name && form.name.value || "").trim();
        const body = {
          name: nameVal || undefined,
          chunking_strategy: form.chunking_strategy.value,
          embedding_model: form.embedding_model.value,
          chunk_size: parseInt(form.chunk_size.value, 10),
          chunk_overlap: parseInt(form.chunk_overlap.value, 10),
        };
        api.post("/v1/configurations", body).then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          if (data && data.id) {
            loadList();
            form.reset();
            document.getElementById("embeddingModel").value = "";
          }
        }).catch(function (err) {
          api.showError(err, "list", "Не удалось создать конфигурацию:");
        });
      };

      auth.init().then(function (authenticated) {
        if (!authenticated) auth.login();
        else auth.updateToken(30).then(loadModels).then(loadList).catch(function () { auth.login(); });
      }).catch(function () { auth.login(); });
    })();
  </script>
</body>
</html>
