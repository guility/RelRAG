<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RelRAG — Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/theme.js"></script>
</head>
<body>
  <header>
    <h1>RelRAG</h1>
    <nav class="flex gap-1">
      <a href="index.html">Главная</a>
      <a href="configurations.html">Конфигурации</a>
      <a href="collections.html">Коллекции</a>
      <a href="document.html">Документ</a>
      <button type="button" id="btnTheme" aria-label="Тема"></button>
      <button type="button" id="btnLogout">Выход</button>
    </nav>
  </header>

  <main>
    <h2>Коллекции</h2>
    <div id="collections"></div>
    <div id="hintFirstCollection" class="hint" style="display:none">
      <strong>Как создать первую коллекцию</strong>
      <ol>
        <li>Перейдите в <a href="configurations.html">Конфигурации</a> и создайте конфигурацию (модель эмбеддингов, размер чанка).</li>
        <li>Перейдите в <a href="collections.html">Коллекции</a> и создайте коллекцию, выбрав конфигурацию.</li>
        <li>Загрузите документы через <a href="document.html">Документ</a> или на странице коллекции.</li>
      </ol>
    </div>
    <h3>Поиск</h3>
    <div id="hintFirstSearch" class="hint" style="display:none">
      <strong>Как выполнить первый поиск</strong>
      <ol>
        <li>Выберите коллекцию из списка.</li>
        <li>Введите запрос (например, ключевые слова из загруженных документов).</li>
        <li>Нажмите «Искать» — результаты покажут релевантные фрагменты с оценкой.</li>
      </ol>
    </div>
    <form id="formSearch">
      <label>Коллекция <select id="searchCollection" required></select></label>
      <label>Запрос <input type="text" id="searchQuery" placeholder="текст для поиска" required></label>
      <div id="searchFilters" class="card" style="margin-top:1rem;display:none;"></div>
      <button type="submit" style="margin-top:1rem">Искать</button>
    </form>
    <div id="searchResults"></div>
  </main>

  <script src="js/layout.js"></script>
  <script src="vendor/keycloak.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script>
    (function () {
      const api = window.relragApi;
      const auth = window.relragAuth;

      function renderCollections(items) {
        const el = document.getElementById("collections");
        const hintColl = document.getElementById("hintFirstCollection");
        const hintSearch = document.getElementById("hintFirstSearch");
        if (!items || items.length === 0) {
          el.innerHTML = "<p>Нет коллекций. <a href='collections.html'>Создать</a></p>";
          if (hintColl) hintColl.style.display = "block";
          if (hintSearch) hintSearch.style.display = "none";
          return;
        }
        if (hintColl) hintColl.style.display = "none";
        if (hintSearch) hintSearch.style.display = "block";
        el.innerHTML = "<div class='card'><table><thead><tr><th>ID</th><th>Конфигурация</th><th>Создана</th><th></th></tr></thead><tbody>" +
          items.map(function (c) {
            return "<tr><td>" + c.id + "</td><td>" + c.configuration_id + "</td><td>" + c.created_at + "</td>" +
              "<td><a href='collection.html?id=" + c.id + "'>Открыть</a> | <a href='admin.html?collection=" + c.id + "'>Админ</a></td></tr>";
          }).join("") + "</tbody></table></div>";
      }

      function loadCollections() {
        return api.get("/v1/collections").then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          if (data && data.items) {
            renderCollections(data.items);
            const sel = document.getElementById("searchCollection");
            sel.innerHTML = "<option value=''>Выберите коллекцию</option>" +
              data.items.map(function (c) {
                return "<option value='" + c.id + "'>" + c.id + "</option>";
              }).join("");
          }
        }).catch(function () {});
      }

      document.getElementById("btnLogout").onclick = function () { auth.logout(); };

      var propertySchema = [];
      function loadPropertySchema(cid) {
        if (!cid) {
          document.getElementById("searchFilters").style.display = "none";
          document.getElementById("searchFilters").innerHTML = "";
          return Promise.resolve();
        }
        return api.get("/v1/collections/" + cid + "/property-schema").then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          propertySchema = (data && data.properties) ? data.properties : [];
          var container = document.getElementById("searchFilters");
          if (propertySchema.length === 0) {
            container.style.display = "none";
            container.innerHTML = "";
            return;
          }
          container.style.display = "block";
          container.innerHTML = "<strong>Фильтры по свойствам</strong>";
          propertySchema.forEach(function (prop, idx) {
            var block = document.createElement("div");
            block.style.marginTop = "0.5rem";
            block.setAttribute("data-key", prop.key);
            block.setAttribute("data-type", prop.type);
            if (prop.type === "string" && prop.values && prop.values.length > 0) {
              block.innerHTML = "<label style='display:block'>" + prop.key + " (мультивыбор)</label>" +
                "<input type='text' class='filter-search' placeholder='Поиск...' style='width:100%;max-width:300px;margin-bottom:4px'>" +
                "<div class='filter-values' style='max-height:120px;overflow-y:auto'>" +
                (prop.values.map(function (v) {
                  return "<label style='display:block'><input type='checkbox' class='filter-one-of' value=\"" + String(v).replace(/"/g, "&quot;") + "\"> " + String(v) + "</label>";
                }).join("")) + "</div>";
            } else if (prop.type === "bool") {
              block.innerHTML = "<label style='display:block'><input type='checkbox' class='filter-bool'> " + prop.key + " (да)</label>";
            } else if (prop.type === "int" || prop.type === "float" || prop.type === "date") {
              var inputType = prop.type === "date" ? "date" : "number";
              block.innerHTML = "<label style='display:block'>" + prop.key + "</label>" +
                "<span>От <input type='" + inputType + "' class='filter-gte' style='width:120px'></span> " +
                "<span>До <input type='" + inputType + "' class='filter-lte' style='width:120px'></span>";
            } else {
              block.innerHTML = "<label style='display:block'>" + prop.key + " (тип: " + prop.type + ")</label>";
            }
            container.appendChild(block);
          });
          container.querySelectorAll(".filter-search").forEach(function (searchInput) {
            searchInput.oninput = function () {
              var q = (searchInput.value || "").toLowerCase();
              var div = searchInput.nextElementSibling;
              div.querySelectorAll("label").forEach(function (l) {
                var text = (l.textContent || "").toLowerCase();
                l.style.display = text.indexOf(q) >= 0 ? "block" : "none";
              });
            };
          });
        }).catch(function () {
          document.getElementById("searchFilters").style.display = "none";
        });
      }
      function gatherFilters() {
        var filters = {};
        var container = document.getElementById("searchFilters");
        if (!container) return undefined;
        container.querySelectorAll("[data-key]").forEach(function (block) {
          var key = block.getAttribute("data-key");
          var type = block.getAttribute("data-type");
          if (type === "string") {
            var checked = [];
            block.querySelectorAll(".filter-one-of:checked").forEach(function (cb) { checked.push(cb.value); });
            if (checked.length) filters[key] = { one_of: checked };
          } else if (type === "bool") {
            var cb = block.querySelector(".filter-bool");
            if (cb && cb.checked) filters[key] = true;
          } else if (type === "int" || type === "float" || type === "date") {
            var gte = block.querySelector(".filter-gte");
            var lte = block.querySelector(".filter-lte");
            var v1 = gte && gte.value ? (type === "int" || type === "float" ? parseFloat(gte.value) : gte.value) : null;
            var v2 = lte && lte.value ? (type === "int" || type === "float" ? parseFloat(lte.value) : lte.value) : null;
            if (v1 != null || v2 != null) {
              filters[key] = {};
              if (v1 != null) filters[key].gte = v1;
              if (v2 != null) filters[key].lte = v2;
            }
          }
        });
        return Object.keys(filters).length ? filters : undefined;
      }
      document.getElementById("searchCollection").onchange = function () {
        loadPropertySchema(this.value);
      };

      document.getElementById("formSearch").onsubmit = function (e) {
        e.preventDefault();
        const collId = document.getElementById("searchCollection").value;
        const query = document.getElementById("searchQuery").value;
        if (!collId || !query) return;
        var body = { query: query, limit: 10 };
        var filters = gatherFilters();
        if (filters) body.filters = filters;
        api.post("/v1/collections/" + collId + "/search", body)
          .then(function (res) { return api.handleResponse(res); })
          .then(function (data) {
            const el = document.getElementById("searchResults");
            if (data && data.results && data.results.length > 0) {
              el.innerHTML = "<ul class='search-results'>" + data.results.map(function (r) {
                return "<li>" + (r.content || "").substring(0, 200) + " <small>(score: " + r.score + ")</small></li>";
              }).join("") + "</ul>";
            } else {
              el.innerHTML = "<p>Ничего не найдено</p>";
            }
          }).catch(function () {
            document.getElementById("searchResults").innerHTML = "<p class='error'>Ошибка поиска</p>";
          });
      };

      auth.init().then(function (authenticated) {
        if (!authenticated) auth.login();
        else auth.updateToken(30).then(loadCollections).catch(function () { auth.login(); });
      }).catch(function () { auth.login(); });
    })();
  </script>
</body>
</html>
