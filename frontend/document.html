<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RelRAG — Загрузка документа</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/theme.js"></script>
</head>
<body>
  <header>
    <h1>RelRAG</h1>
    <nav class="flex gap-1">
      <a href="index.html">Главная</a>
      <a href="configurations.html">Конфигурации</a>
      <a href="collections.html">Коллекции</a>
      <a href="document.html">Документ</a>
      <button type="button" id="btnTheme" aria-label="Тема"></button>
      <button type="button" id="btnLogout">Выход</button>
    </nav>
  </header>

  <main>
    <h2>Загрузить документ</h2>
    <div class="hint">
      <strong>Загрузка текста или файлов</strong>
      <p>Выберите коллекцию и либо вставьте текст, либо приложите файлы (txt, md, csv, tsv, docx, pdf, xlsx, pptx, epub). Метаданные из файлов сохраняются в свойства документа.</p>
    </div>
    <form id="formDoc">
      <label>Коллекция <select id="collId" required></select></label>
      <label>Файлы <input type="file" id="fileInput" name="files" multiple accept=".txt,.md,.csv,.tsv,.docx,.pdf,.xlsx,.pptx,.epub"></label>
      <label>Или текст <textarea id="docContent" rows="10" placeholder="вставьте текст или выберите файлы выше"></textarea></label>
      <button type="submit" id="btnSubmit">Загрузить</button>
    </form>
    <div id="uploadProgress" class="upload-progress" style="display:none" aria-live="polite">
      <div class="upload-progress-bar-wrap">
        <div class="upload-progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div class="upload-progress-label"></div>
    </div>
    <div id="msg"></div>
  </main>

  <script src="js/layout.js"></script>
  <script src="vendor/keycloak.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script>
    (function () {
      const api = window.relragApi;
      const auth = window.relragAuth;
      function escapeHtml(s) { return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }

      function loadCollections() {
        return api.get("/v1/collections").then(function (res) {
          return api.handleResponse(res);
        }).then(function (data) {
          const sel = document.getElementById("collId");
          sel.innerHTML = "<option value=''>Выберите коллекцию</option>";
          if (data && data.items) {
            data.items.forEach(function (c) {
              var label = (c.name && c.name.trim()) ? c.name : c.id;
              sel.innerHTML += "<option value='" + c.id + "'>" + escapeHtml(label) + "</option>";
            });
          }
        }).catch(function (err) {
          api.showError(err, "msg", "Не удалось загрузить коллекции:");
        });
      }

      document.getElementById("btnLogout").onclick = function () { auth.logout(); };

      document.getElementById("formDoc").onsubmit = function (e) {
        e.preventDefault();
        const collId = document.getElementById("collId").value;
        const fileInput = document.getElementById("fileInput");
        const content = document.getElementById("docContent").value.trim();
        const files = fileInput && fileInput.files ? fileInput.files : [];
        if (!collId) return;
        if (files.length > 0) {
          const formData = new FormData();
          formData.append("collection_id", collId);
          for (var i = 0; i < files.length; i++) {
            formData.append("files", files[i], files[i].name);
          }
          const cfg = window.RELRAG_CONFIG || {};
          const API_URL = (cfg.API_URL || "").replace(/\/$/, "");
          const token = auth.getToken();
          const headers = {};
          if (token) headers["Authorization"] = "Bearer " + token;
          const progressEl = document.getElementById("uploadProgress");
          const barEl = progressEl.querySelector(".upload-progress-bar");
          const labelEl = progressEl.querySelector(".upload-progress-label");
          const msgEl = document.getElementById("msg");
          const btnSubmit = document.getElementById("btnSubmit");
          msgEl.innerHTML = "";
          progressEl.style.display = "block";
          barEl.style.width = "0%";
          barEl.setAttribute("aria-valuenow", "0");
          labelEl.textContent = "Подготовка…";
          btnSubmit.disabled = true;
          fetch(API_URL + "/v1/documents/stream", {
            method: "POST",
            headers: headers,
            body: formData,
            credentials: "omit",
          }).then(function (res) {
            if (!res.ok) {
              return res.json().then(function (data) {
                return Promise.reject({ status: res.status, message: (data && data.error) || res.statusText });
              }).catch(function (e) {
                if (e && (e.status !== undefined || e.message)) return Promise.reject(e);
                return Promise.reject({ status: res.status, message: res.statusText });
              });
            }
            if (!res.body) return Promise.reject({ message: "No response body" });
            var buf = "";
            var dec = new TextDecoder();
            var reader = res.body.getReader();
            function processBlock(block) {
              var eventType = "";
              var dataStr = "";
              block.split("\n").forEach(function (line) {
                if (line.indexOf("event: ") === 0) eventType = line.slice(7).trim();
                if (line.indexOf("data: ") === 0) dataStr = line.slice(6);
              });
              if (!dataStr) return;
              try {
                var data = JSON.parse(dataStr);
                if (eventType === "progress") {
                  var total = data.total || 1;
                  var current = data.current || 0;
                  var pct = total ? Math.round((current / total) * 100) : 0;
                  barEl.style.width = pct + "%";
                  barEl.setAttribute("aria-valuenow", String(pct));
                  labelEl.textContent = data.status === "processing"
                    ? "Обработка " + current + " из " + total + ": " + (data.filename || "")
                    : (data.filename || "") + " — " + (data.status === "ok" ? "готово" : (data.error || data.status));
                } else if (eventType === "done") {
                  progressEl.style.display = "none";
                  btnSubmit.disabled = false;
                  if (data.documents && data.documents.length > 0) {
                    var errStr = data.errors && data.errors.length ? " Ошибки: " + data.errors.length : "";
                    msgEl.innerHTML = "<p class='success'>Загружено документов: " + data.documents.length + errStr + "</p>";
                    fileInput.value = "";
                  } else if (data.errors && data.errors.length > 0) {
                    msgEl.innerHTML = "<p class='error'>Ошибки загрузки: " + data.errors.map(function (x) { return x.filename + " — " + x.error; }).join("; ") + "</p>";
                  } else {
                    msgEl.innerHTML = "<p class='error'>Не удалось загрузить</p>";
                  }
                } else if (eventType === "error") {
                  progressEl.style.display = "none";
                  btnSubmit.disabled = false;
                  api.showError({ message: data.message || "Ошибка загрузки" }, "msg", "Ошибка загрузки файлов:");
                }
              } catch (e) { /* ignore parse errors */ }
            }
            function pump() {
              return reader.read().then(function (result) {
                if (result.done) {
                  progressEl.style.display = "none";
                  btnSubmit.disabled = false;
                  return;
                }
                buf += dec.decode(result.value, { stream: true });
                var parts = buf.split("\n\n");
                buf = parts.pop() || "";
                parts.forEach(processBlock);
                return pump();
              });
            }
            return pump();
          }).catch(function (err) {
            progressEl.style.display = "none";
            btnSubmit.disabled = false;
            api.showError(err, "msg", "Ошибка загрузки файлов:");
          });
          return;
        }
        if (!content) return;
        api.post("/v1/documents", { collection_id: collId, content: content, properties: {} })
          .then(function (res) { return api.handleResponse(res); })
          .then(function (data) {
            const el = document.getElementById("msg");
            if (data && data.id) {
              el.innerHTML = "<p class='success'>Документ загружен: " + data.id + "</p>";
              document.getElementById("docContent").value = "";
            } else {
              el.innerHTML = "<p class='error'>Ошибка</p>";
            }
          }).catch(function (err) {
            api.showError(err, "msg", "Ошибка загрузки документа:");
          });
      };

      auth.init().then(function (authenticated) {
        if (!authenticated) auth.login();
        else auth.updateToken(30).then(loadCollections).catch(function () { auth.login(); });
      }).catch(function () { auth.login(); });
    })();
  </script>
</body>
</html>
